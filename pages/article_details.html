<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Article details</title>
    <link rel="stylesheet" href="../styles/home_page.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <meta name="viewport" content="width=device-width, init-scale=1.0">
    <script>
        const currentUrl = window.location.href;
        const params = new URLSearchParams(new URL(currentUrl).search);
        const id = params.get('id');
        const apiUrl = `https://my-brand-api-t81n.onrender.com/articles/getSingleArticle/${id}`
        const createCommentApi = `https://my-brand-api-t81n.onrender.com/comments/createComments/${id}`
    </script>
</head>
<body>

<main class="article-container">
    <nav class="navigation">
        <label class="logo">
            RM-BRAND
        </label>
        <ul class="links">
            <li><a href="../index.html#about-section" id="about">About me</a></li>
            <li><a href="../index.html#experience-section" id="experience">Experience</a></li>
            <li><a href="../index.html#skills-section" id="skills">Skills</a></li>
            <li><a href="../index.html#work-section" id="work">Work</a></li>
            <li><a href="../index.html#contact-section" id="contactMe">Contact</a></li>
            <li><a href="../index.html#blog-section" id="blog">Blog</a></li>
        </ul>
    </nav>
    <article class="article-page"></article>
    <div class="loadingArticle" style="text-align:center;padding: 3em"></div>
    <section class="comments"></section>
    <section id="contact-section" class="contact-section">
        <div class="contact-section-form">
            <div class="contact-section-form-title">
                Comment
                <div class="border-bottom"></div>
            </div>
            <form class="contact-form">
                <div class="comment-feedback"></div>
                <div class="email-input">
                    <div><label for="names">Names</label></div>
                    <div><input type="text" id="names"></div>
                </div>
                <div class="email-input">
                    <div><label for="email">Email</label></div>
                    <div><input type="text" id="email"></div>
                </div>
                <div class="message-input">
                    <div><label for="contentBody">Comment</label></div>
                    <div><textarea name="message" id="contentBody" cols="30" rows="10"></textarea></div>
                </div>
                <button type="submit" id="commentSubmit">Send</button>
            </form>
        </div>
    </section>
</main>
</body>
<script>
    async function deleteComment(id) {
        const deleteApi = `https://my-brand-api-t81n.onrender.com/comments/removeComment/${id}`
        const askUser = confirm("Really want to delete this comment ?")
        if (askUser) {
            const options = {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
            }
            const deleteResponse = await fetch(deleteApi, options)
            if (!deleteResponse.ok) {
                const deleteError = await deleteResponse.json()
                console.log(deleteError)
            }
            if (deleteResponse.ok) {
                const data = await deleteResponse.json()
                toastMethod(data.message)
                console.log(data.message)
            }
        }
    }
</script>
<script>

    const token = localStorage.getItem("token");
    const articleSection = document.querySelector(".article-page")
    const commentSection = document.querySelector(".comments")
    const commentForm = document.querySelector("#contact-section")
    const loading = document.querySelector(".loadingArticle")
    commentForm.style = "display:none"
    const fetchSingleArticle = async () => {

        try {
            loading.textContent = "Waiting..."
            const response = await fetch(apiUrl)
            if (!response.ok) {
                const data = await response.json()
                loading.style = "display:flex"
                loading.textContent = `${data.message}`
            }
            if (response.ok) {
                loading.style = "display:none;"
                commentForm.style = "display:flex"
                const data = await response.json()
                const article = data.article;
                const articleCome = data.article.comments.reverse();

                const titleCard = document.createElement("div")
                titleCard.classList.add("article-title")

                const bodyCard = document.createElement("div")
                bodyCard.classList.add("article-body")

                const thumbCard = document.createElement("div")
                thumbCard.classList.add("thumbnail")

                titleCard.innerHTML = `${article.title}`
                bodyCard.innerHTML = `${article.body}`
                thumbCard.innerHTML = `<div style="margin: auto;width: 60%;padding: 10px;"><figure><img src="${article.thumbnail}" class="" height="40%" width="70%" alt=""></figure></div>`

                //Articles

                articleSection.appendChild(thumbCard)
                articleSection.appendChild(titleCard)
                articleSection.appendChild(bodyCard)

                for (let i = 0; i < articleCome.length; i++) {
                    const commentatorCard = document.createElement("div")
                    commentatorCard.classList.add("commentator")

                    const commentCard = document.createElement("div")
                    commentCard.classList.add("comment")
                    commentCard.style = "margin-bottom:1rem"

                    commentatorCard.innerHTML = `${articleCome[i].names}`
                    commentCard.innerHTML = `${articleCome[i].content}`

                    const actionSection = document.createElement("div")
                    actionSection.style = "display:block;margin-bottom:1rem;"
                    actionSection.innerHTML = `<button onClick="deleteComment('${articleCome[i]._id}')" style="color:white;background: red;border: none;border-radius: 5px;padding: .4rem .5rem">Delete</button>`

                    //Comments
                    commentSection.appendChild(commentatorCard)
                    commentSection.appendChild(commentCard)
                    if (token) {
                        commentSection.appendChild(actionSection)
                    }
                    console.log(commentSection)
                }
            }
        } catch (error) {
            loading.style = "display:flex"
            loading.textContent = `${error.message}`
            console.log(error)
        }
    }
    fetchSingleArticle()
</script>
<script>
    let commentButton = document.querySelector(".contact-form")
    let commentatorNames = document.querySelector("#names")
    let commentatorEmail = document.querySelector("#email")
    let commentatorContent = document.querySelector("#contentBody")
    let commentFeedback = document.querySelector(".comment-feedback")
    let submitComment = document.querySelector("#commentSubmit")

    commentButton.addEventListener("submit", async function (e) {
        submitComment.textContent = "Loading..."
        e.preventDefault()

        const comment = {
            "names": commentatorNames.value,
            "email": commentatorEmail.value,
            "content": commentatorContent.value
        }
        const options = {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                // "Authorization": `Bearer ${localStorage.getItem("token")}`
            },
            body: JSON.stringify(comment)
        }

        try {
            const response = await fetch(createCommentApi, options)
            if (!response.ok) {

                submitComment.textContent = "Send"
                commentFeedback.textContent = ""
                const error = await response.json()
                commentFeedback.style = "color:red;align:center;padding:1rem;"
                commentFeedback.textContent = `${error.message}`
                console.log(`HERE IS DATA: ${error}`)
            }
            if (response.ok) {
                submitComment.textContent = "Send"
                commentFeedback.textContent = ""
                commentButton.reset()
                commentFeedback.style = "color:green;align:center;padding:1rem;"
                const data = await response.json()
                commentFeedback.textContent = `${data.message}`
            }
        } catch (error) {
            submitComment.textContent = "Send"
            commentFeedback.style = "color:red;align:center;padding:1rem;"
            commentFeedback.textContent = `${error.message}`
            console.log(`Error during comment create: ${e}`)
        }

        // const isFormValid = checkLoginEmail() && checkPassword()
        // if (isFormValid) {
        //     try {
        //         if (response.ok) {
        //             const data = await response.json()
        //             console.log(data.token)
        //             localStorage.setItem("token", data.token)
        //             window.location = "https://deploy-preview-2--rene-mucyo-brand.netlify.app/dashboard/index.html"
        //         }
        //     } catch (error) {
        //         console.log("")
        //     }
        //     // const myCredentials = window.localStorage.getItem("user")
        //     // const auth = JSON.parse(myCredentials)
        //     // if (auth["email"] === username.value && auth["password"] === password.value) {
        //     //     window.location = "http://localhost:63343/my-brand/dashboard/index.html"
        //     // } else {
        //     //     const notMatch = document.querySelector("#login-failed")
        //     //     notMatch.style.color = "red"
        //     //     notMatch.textContent = "We have not that credentials in database"
        //     // }
        // }
    })
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
    function updateDiv() {

        const container = document.querySelector(".comments");
        let content = container.innerHTML;
        container.innerHTML = content;
        console.log("REFRESHED")
    }

    function toastMethod(message) {
        Toastify({
            text: message,
            duration: 3000,
            newWindow: true,
            close: true,
            gravity: "top", // `top` or `bottom`
            position: "right", // `left`, `center` or `right`
            stopOnFocus: true, // Prevents dismissing of toast on hover
            style: {
                background: "color:red;"
                // background: "linear-gradient(to right, #00b09b, #96c93d)",
            },
            onClick: function () {
            } // Callback after click
        }).showToast();
    }
</script>
</html>